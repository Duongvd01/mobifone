<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real-Time Audio Transcription</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
        margin: 20px;
        line-height: 1.6;
        background-color: #f4f7fc;
        color: #333;
      }

      h1,
      h2 {
        color: #007bff;
        text-align: center;
      }

      p {
        text-align: center;
        font-size: 16px;
      }

      .button-container {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
      }

      .button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        transition: background-color 0.3s ease;
        color: white;
      }

      .start-btn {
        background-color: #28a745;
      }

      .stop-btn {
        background-color: #dc3545;
      }

      .back-btn {
        background-color: #007bff;
      }

      .button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }

      .transcription {
        border: 1px solid #ccc;
        padding: 15px;
        margin-top: 20px;
        max-height: 300px;
        overflow-y: auto;
        background: #f9f9f9;
        border-radius: 4px;
      }

      .language-selector {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }

      select {
        padding: 10px;
        font-size: 16px;
        border-radius: 4px;
        border: 1px solid #ccc;
        cursor: pointer;
      }

      .header-container {
        text-align: center;
        margin-bottom: 30px;
      }
    </style>
  </head>

  <body>
    <h1>Real-Time Audio Transcription</h1>
    <p>
      Click "Start Recording" to begin transcribing your audio in real-time.
    </p>
    <div class="language-selector">
      <label for="languageSelect" style="font-size: 16px; margin-right: 10px"
        >Choose Language:</label
      >
      <select id="languageSelect">
        <option value="en-US">English</option>
        <option value="vi-VN">Vietnamese</option>
      </select>
    </div>
    <div class="button-container">
      <button class="button start-btn" id="startButton">Start Recording</button>
      <button class="button stop-btn" id="stopButton" disabled>
        Stop Recording
      </button>
      <button class="button back-btn" id="backButton">Go Back</button>
    </div>

    <h2>Transcription</h2>
    <div class="transcription" id="transcription"></div>

    <script>
      const languageSelect = document.getElementById("languageSelect");
      const startButton = document.getElementById("startButton");
      const stopButton = document.getElementById("stopButton");
      const backButton = document.getElementById("backButton");
      const transcriptionDiv = document.getElementById("transcription");
      let isRecording = false;

      let websocket;
      let mediaStream;
      let audioContext;
      let processorNode;

      const CLOSE_SIGNAL = "CLOSE";
      startButton.addEventListener("click", () => {
        isRecording = true;
        startButton.disabled = true;
        stopButton.disabled = false;

        const language = languageSelect.value; // Get selected language
        // Initialize recording and transcription based on selected language
        transcriptionDiv.innerHTML = `Recording in ${
          language === "en-US" ? "English" : "Vietnamese"
        }...`;

        // Add your WebSocket or API logic here to handle real-time transcription
      });

      // Stop recording
      stopButton.addEventListener("click", () => {
        isRecording = false;
        startButton.disabled = false;
        stopButton.disabled = true;
        transcriptionDiv.innerHTML = "Recording stopped.";
      });

      // Go back button logic
      backButton.addEventListener("click", () => {
        window.history.back(); // Go back to the previous page
      });

      async function startRecording() {
        try {
          startButton.disabled = true;
          stopButton.disabled = false;
          transcriptionDiv.innerHTML = "";

          // Request microphone access
          mediaStream = await navigator.mediaDevices.getUserMedia({
            audio: { echoCancellation: true, noiseSuppression: true },
          });
          audioContext = new AudioContext({
            sampleRate: 16000,
          });

          // Create AudioWorkletProcessor
          await audioContext.audioWorklet.addModule("processor.js"); // Add processor file
          processorNode = new AudioWorkletNode(audioContext, "processor");

          const source = audioContext.createMediaStreamSource(mediaStream);
          source.connect(processorNode);
          processorNode.connect(audioContext.destination);

          // Handle WebSocket connection
          websocket = new WebSocket("wss://14.224.188.206:8100/record");

          websocket.onopen = () => {
            console.log("WebSocket connection opened.");
            websocket.send(
              JSON.stringify({
                target_language: "en",
              })
            );
          };
          websocket.onmessage = (event) => handleWebSocketMessage(event);
          websocket.onerror = (error) =>
            console.error("WebSocket error:", error);
          websocket.onclose = () => console.log("WebSocket connection closed.");

          processorNode.port.onmessage = (event) => {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
              websocket.send(event.data);
            }
          };
        } catch (error) {
          console.error("Error starting recording:", error);
          stopRecording();
        }
      }

      function handleWebSocketMessage(event) {
        try {
          const message = JSON.parse(event.data);
          const { text } = message;

          // Display only the transcribed text, without time and language
          transcriptionDiv.innerHTML += `<p>${text}</p>`;
          transcriptionDiv.scrollTop = transcriptionDiv.scrollHeight;
        } catch (error) {
          console.error("Error parsing JSON:", error);
        }
      }

      function stopRecording() {
        if (mediaStream) {
          mediaStream.getTracks().forEach((track) => track.stop());
        }
        if (audioContext) {
          audioContext.close();
        }
        if (websocket && websocket.readyState === WebSocket.OPEN) {
          websocket.send(CLOSE_SIGNAL);
          websocket.close();
        }
        startButton.disabled = false;
        stopButton.disabled = true;
      }

      backButton.addEventListener("click", () => {
        window.history.back(); // Navigate to the previous page
      });

      document.addEventListener("visibilitychange", () => {
        if (document.hidden) stopRecording();
      });

      startButton.addEventListener("click", startRecording);
      stopButton.addEventListener("click", stopRecording);
    </script>
  </body>
</html>